<!DOCTYPE html>
<html>
<head>
<title>Solar 4:20 Tracker (Enhanced)</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<style>
#map {
    height: 100vh;
    width: 100%;
}

body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
    background: #1a1a1a;
}

.longitude {
    font-size: 18px;
    font-weight: bold;
    margin: 5px 0;
    color: #1db954;
    text-align: center;
}

.countries-container {
    margin-top: 8px;
    padding: 8px;
    background: rgba(29, 185, 84, 0.1);
    border-radius: 6px;
}

.countries-title {
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 14px;
    text-align: center;
    color: #1db954;
}

.countries-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 6px;
    max-height: 200px;
    overflow-y: auto;
    padding: 4px;
}

.country-tag {
    background: #1db954;
    color: #000;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
}



.central-time-display {
    position: absolute;
    top: 10px;
    left: 50px;
    z-index: 1000;
    background: rgba(34, 34, 34, 0.95);
    padding: 15px 25px;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    border: 2px solid #1db954;
    text-align: center;
    min-width: 280px;
}

.time-slider-container {
    position: absolute;
    bottom: 350px;
    left: 10px;
    transform: none;
    z-index: 1000;
    background: rgba(34, 34, 34, 0.95);
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    border: 2px solid #1db954;
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 300px;
}

.adjustment-buttons {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    width: 100%;
    justify-content: center;
}

.adjustment-button {
    background: #1db954;
    border: none;
    color: black;
    padding: 6px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    transition: background-color 0.3s;
    min-width: 40px;
}

.adjustment-button:hover {
    background: #15843c;
}

.adjustment-button:active {
    transform: scale(0.95);
}

.adjustment-label {
    color: #1db954;
    font-size: 12px;
    text-align: center;
    margin-top: 4px;
}

.info-box {
    position: absolute;
    bottom: 10px;
    left: 10px;
    transform: none;
    z-index: 1000;
    background: rgba(34, 34, 34, 0.95);
    padding: 12px;
    border-radius: 8px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    width: 600px;
    max-width: none;
    color: #e0e0e0;
    border: 2px solid #1db954;
}

.time-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 5px 0;
    font-family: monospace;
    font-size: 24px;
    color: #1db954;
}

.time-label {
    color: rgba(255, 255, 255, 0.7);
    font-size: 14px;
    text-transform: uppercase;
    font-weight: bold;
    width: 60px;
    text-align: right;
    margin-right: 15px;
}

.time-value {
    font-weight: bold;
    letter-spacing: 2px;
}

.time-offset {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid rgba(29, 185, 84, 0.3);
}

.time-detail {
    font-size: 11px;
    margin-top: 2px;
    color: rgba(255, 255, 255, 0.7);
}

.country-tag.next {
    background: #ff4b20;
    animation: pulse 2s infinite;
}

.time-detail.next {
    color: #fff;
    font-weight: bold;
}

.bar-label {
    font-size: 14px;
    padding: 4px;
    background: #1db954;
    color: #000;
    border-radius: 3px;
    border: 1px solid #000;
    white-space: nowrap;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.03); }
    100% { transform: scale(1); }
}

::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: #1db954;
    border-radius: 3px;
}

.time-slider {
    width: 100%;
    margin: 10px 0;
    -webkit-appearance: none;
    appearance: none;
    height: 4px;
    background: #1db954;
    outline: none;
    border-radius: 2px;
}

.time-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #1db954;
}

.time-slider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: #fff;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid #1db954;
}

.time-offset-display {
    color: #1db954;
    font-size: 14px;
    margin-top: 5px;
    font-family: monospace;
}

.reset-button {
    margin-top: 5px;
    padding: 4px 12px;
    background: #1db954;
    border: none;
    border-radius: 4px;
    color: black;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.3s;
}

.reset-button:hover {
    background: #15843c;
}
/* Add these media queries at the end of your existing CSS */
@media screen and (max-width: 768px) {
    .central-time-display {
        left: 10px;
        top: 10px;
        min-width: auto;
        width: calc(100% - 20px);
        padding: 8px 12px;
        font-size: 14px;
    }

    .time-slider-container {
        bottom: 220px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 20px);
        max-width: 300px;
        padding: 8px 12px;
    }

    .adjustment-buttons {
        flex-wrap: wrap;
        gap: 5px;
    }

    .adjustment-button {
        padding: 4px 8px;
        font-size: 12px;
        min-width: 30px;
    }

    .info-box {
        width: calc(100% - 20px);
        left: 10px;
        padding: 8px;
        max-height: 200px;
        overflow-y: auto;
    }

    .countries-list {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 4px;
        max-height: 150px;
    }

    .country-tag {
        padding: 3px 6px;
        font-size: 11px;
    }

    .time-row {
        font-size: 18px;
    }

    .time-label {
        font-size: 12px;
        width: 50px;
    }

    .time-detail {
        font-size: 10px;
    }

    .bar-label {
        font-size: 12px;
        padding: 3px;
    }

    .time-offset-display {
        font-size: 12px;
    }

    .reset-button {
        padding: 3px 10px;
        font-size: 11px;
    }

    .longitude {
        font-size: 16px;
    }

    .countries-title {
        font-size: 12px;
    }
}

@media screen and (max-width: 480px) {
    .time-slider-container {
        bottom: 200px;
    }

    .countries-list {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }

    .time-row {
        font-size: 16px;
    }

    .adjustment-button {
        padding: 3px 6px;
        font-size: 11px;
    }
}
</style>
</head>
<body>
    <div id="map"></div>
    <div class="time-slider-container">
        <input type="range" class="time-slider" id="timeSlider" min="-720" max="720" value="0" step="1">
        <div class="time-offset-display" id="timeOffsetDisplay">Current Time</div>
        <div class="adjustment-buttons">
            <button class="adjustment-button" onclick="adjustTime(-60)">-1h</button>
            <button class="adjustment-button" onclick="adjustTime(-5)">-5m</button>
            <button class="adjustment-button" onclick="adjustTime(-1)">-1m</button>
            <button class="adjustment-button" onclick="adjustTime(1)">+1m</button>
            <button class="adjustment-button" onclick="adjustTime(5)">+5m</button>
            <button class="adjustment-button" onclick="adjustTime(60)">+1h</button>
        </div>
        <div class="adjustment-label">Fine Adjustment</div>
        <button class="reset-button" id="resetTime">Reset to Current Time</button>
    </div>
    <div class="info-box" id="infoBox"></div>
<div class="time-display" id="timeDisplay"></div>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// Initialize map
const map = L.map('map', {
    zoomControl: true
}).setView([20, 0], 2);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
}).addTo(map);
let timeOffset = 0;
const timeSlider = document.getElementById('timeSlider');
const timeOffsetDisplay = document.getElementById('timeOffsetDisplay');
const resetTimeButton = document.getElementById('resetTime');
let nextHighlights = [];
let nextBar = null;
let nextLabel = null;
let currentBar = null;
let currentLabel = null;
let autoFollow = false;
const barWidth = 2;

// Optimized country dataset with better longitudinal coverage
// Optimized global coverage with minimal overlap
const countryLatitudes = {
    "United States (Pacific)": [25, 49],
    "United States (Mountain)": [25, 49],
    "United States (Central)": [25, 49],
    "United States (Eastern)": [25, 49],
    "United States (Alaska)": [51, 72],
    "United States (Hawaii)": [18, 23],
    "Canada (Pacific)": [49, 60],
    "Canada (Mountain)": [49, 60],
    "Canada (Central)": [49, 60],
    "Canada (Eastern)": [43, 60],
    "Canada (Atlantic)": [43, 52],
    "Mexico": [14, 33],
    "Brazil (East)": [-34, 6],
    "Brazil (Central)": [-34, 6],
    "Argentina": [-55, -21],
    "Chile": [-56, -17],
    "Peru": [-18, 0],
    "Colombia": [-4, 13],
    "United Kingdom": [49, 61],
    "France": [41, 51],
    "Germany": [47, 55],
    "Poland": [49, 55],
    "Ukraine": [44, 53],
    "Greece": [34, 42],
    "Sweden": [55, 69],
    "Russia (West)": [45, 70],
    "Russia (Central)": [45, 70],
    "Russia (East)": [42, 70],
    "China": [18, 54],
    "Japan": [24, 46],
    "India": [6, 36],
    "Kazakhstan": [40, 56],
    "Indonesia (West)": [-11, 6],
    "Indonesia (Central)": [-11, 6],
    "Indonesia (East)": [-11, 6],
    "Thailand": [5, 21],
    "Vietnam": [8, 24],
    "South Korea": [33, 39],
    "South Africa": [-35, -22],
    "Egypt": [22, 32],
    "Nigeria": [4, 14],
    "Australia (Eastern)": [-45, -10],
    "Australia (Central)": [-38, -12],
    "Australia (Western)": [-35, -14],
    "New Zealand": [-47, -34],
    "Papua New Guinea": [-12, -1],
    "Fiji": [-20, -16],
    "Saudi Arabia": [16, 33],
    "Iran": [25, 40],
    "Turkey": [36, 42],
    "Iceland": [63, 67],
    "Portugal (Azores)": [36, 40]
};
const countryTimeZones = {
    "Iceland": {
        ranges: [[-25, -13]], // Slightly expanded range
        timezones: ["Atlantic/Reykjavik"]
    },
    "Portugal (Azores)": {
        ranges: [[-31, -25]],
        timezones: ["Atlantic/Azores"]
    },
    // North America
    "United States (Pacific)": {
        ranges: [[-125, -114]],
        timezones: ["America/Los_Angeles"]
    },
    "United States (Mountain)": {
        ranges: [[-114, -101]],
        timezones: ["America/Denver", "America/Phoenix"]
    },
    "United States (Central)": {
        ranges: [[-101, -87]],
        timezones: ["America/Chicago"]
    },
    "United States (Eastern)": {
        ranges: [[-87, -67]],
        timezones: ["America/New_York"]
    },
    "United States (Alaska)": {
        ranges: [[172, -130], [-180, 172]],  // Cross-date line handling
        timezones: ["America/Anchorage"]
    },
    "United States (Hawaii)": {
        ranges: [[-160, -154]],
        timezones: ["Pacific/Honolulu"]
    },
    "Canada (Pacific)": {
        ranges: [[-139, -120]],
        timezones: ["America/Vancouver"]
    },
    "Canada (Mountain)": {
        ranges: [[-120, -110]],
        timezones: ["America/Edmonton"]
    },
    "Canada (Central)": {
        ranges: [[-110, -90]],
        timezones: ["America/Winnipeg"]
    },
    "Canada (Eastern)": {
        ranges: [[-90, -64]],
        timezones: ["America/Toronto"]
    },
    "Canada (Atlantic)": {
        ranges: [[-64, -52]],
        timezones: ["America/Halifax"]
    },
    "Mexico": {
        ranges: [[-117, -86]],
        timezones: ["America/Mexico_City"]
    },

    // South America
    "Brazil (East)": {
        ranges: [[-48, -34]],
        timezones: ["America/Sao_Paulo"]
    },
    "Brazil (Central)": {
        ranges: [[-70, -48]],
        timezones: ["America/Manaus"]
    },
    "Argentina": {
        ranges: [[-73, -53]],
        timezones: ["America/Argentina/Buenos_Aires"]
    },
    "Chile": {
        ranges: [[-75, -66]],
        timezones: ["America/Santiago"]
    },
    "Peru": {
        ranges: [[-81, -68]],
        timezones: ["America/Lima"]
    },
    "Colombia": {
        ranges: [[-79, -66]],
        timezones: ["America/Bogota"]
    },

    // Europe
    "United Kingdom": {
        ranges: [[-8, 2]],
        timezones: ["Europe/London"]
    },
    "France": {
        ranges: [[-5, 8]],
        timezones: ["Europe/Paris"]
    },
    "Germany": {
        ranges: [[6, 15]],
        timezones: ["Europe/Berlin"]
    },
    "Poland": {
        ranges: [[14, 24]],
        timezones: ["Europe/Warsaw"]
    },
    "Ukraine": {
        ranges: [[22, 40]],
        timezones: ["Europe/Kiev"]
    },
    "Greece": {
        ranges: [[20, 28]],
        timezones: ["Europe/Athens"]
    },
    "Sweden": {
        ranges: [[11, 24]],
        timezones: ["Europe/Stockholm"]
    },

    // Asia
    "Russia (West)": {
        ranges: [[28, 50]],
        timezones: ["Europe/Moscow"]
    },
    "Russia (Central)": {
        ranges: [[50, 90]],
        timezones: ["Asia/Yekaterinburg", "Asia/Novosibirsk"]
    },
    "Russia (East)": {
        ranges: [[90, 180]],
        timezones: ["Asia/Vladivostok"]
    },
    "China": {
        ranges: [[73, 135]],
        timezones: ["Asia/Shanghai"]
    },
    "Japan": {
        ranges: [[123, 146]],
        timezones: ["Asia/Tokyo"]
    },
    "India": {
        ranges: [[68, 97]],
        timezones: ["Asia/Kolkata"]
    },
    "Kazakhstan": {
        ranges: [[46, 88]],
        timezones: ["Asia/Almaty"]
    },
    "Indonesia (West)": {
        ranges: [[95, 115]],
        timezones: ["Asia/Jakarta"]
    },
    "Indonesia (Central)": {
        ranges: [[115, 125]],
        timezones: ["Asia/Makassar"]
    },
    "Indonesia (East)": {
        ranges: [[125, 141]],
        timezones: ["Asia/Jayapura"]
    },
    "Thailand": {
        ranges: [[97, 106]],
        timezones: ["Asia/Bangkok"]
    },
    "Vietnam": {
        ranges: [[102, 109]],
        timezones: ["Asia/Ho_Chi_Minh"]
    },
    "South Korea": {
        ranges: [[126, 130]],
        timezones: ["Asia/Seoul"]
    },

    // Africa
    "South Africa": {
        ranges: [[16, 33]],
        timezones: ["Africa/Johannesburg"]
    },
    "Egypt": {
        ranges: [[25, 37]],
        timezones: ["Africa/Cairo"]
    },
    "Nigeria": {
        ranges: [[3, 15]],
        timezones: ["Africa/Lagos"]
    },
    // Oceania
    "Australia (Eastern)": {
        ranges: [[141, 154]],
        timezones: ["Australia/Sydney"]
    },
    "Australia (Central)": {
        ranges: [[129, 141]],
        timezones: ["Australia/Adelaide"]
    },
    "Australia (Western)": {
        ranges: [[113, 129]],
        timezones: ["Australia/Perth"]
    },
    "New Zealand": {
        ranges: [[166, 179], [-180, -176]],  // Cross-date line handling
        timezones: ["Pacific/Auckland"]
    },
    "Papua New Guinea": {
        ranges: [[141, 157]],
        timezones: ["Pacific/Port_Moresby"]
    },
    "Fiji": {
        ranges: [[177, 180], [-180, -178]],  // Cross-date line handling
        timezones: ["Pacific/Fiji"]
    },
    "Australia (Eastern)": {
        ranges: [[141, 154]],
        timezones: ["Australia/Sydney"]
    },
    "Australia (Central)": {
        ranges: [[129, 141]],
        timezones: ["Australia/Adelaide"]
    },

    // Middle East
    "Saudi Arabia": {
        ranges: [[34, 56]],
        timezones: ["Asia/Riyadh"]
    },
    "Iran": {
        ranges: [[44, 64]],
        timezones: ["Asia/Tehran"]
    },
    "Turkey": {
        ranges: [[26, 45]],
        timezones: ["Europe/Istanbul"]
    }
};

function formatTimeOffset(minutes) {
    if (minutes === 0) return "Current Time";
    const hours = Math.floor(Math.abs(minutes) / 60);
    const mins = Math.abs(minutes) % 60;
    const direction = minutes > 0 ? "ahead" : "behind";
    return `${hours}h ${mins}m ${direction}`;
}

// Add event listeners for the slider and reset button
timeSlider.addEventListener('input', function(e) {
    timeOffset = parseInt(e.target.value);
    timeOffsetDisplay.textContent = formatTimeOffset(timeOffset);
    updateSolar420Location();
});

resetTimeButton.addEventListener('click', function() {
    timeOffset = 0;
    timeSlider.value = 0;
    timeOffsetDisplay.textContent = "Current Time";
    updateSolar420Location();
});

function getLocalTime(timezone) {
    try {
        const now = new Date();
        const offsetTime = new Date(now.getTime() + timeOffset * 60000);
        const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: timezone,
            hour: '2-digit',
            minute: '2-digit',
            hour12: false
        });
        return formatter.format(offsetTime);
    } catch (e) {
        console.error(`Error getting time for timezone ${timezone}:`, e);
        return null;
    }
}

function formatTime(date) {
    return `${date.getHours().toString().padStart(2, '0')}:${
        date.getMinutes().toString().padStart(2, '0')}:${
        date.getSeconds().toString().padStart(2, '0')}`;
}

function adjustTime(minutes) {
    timeOffset = parseInt(timeSlider.value) + minutes;
    // Ensure we stay within slider bounds
    timeOffset = Math.max(-720, Math.min(720, timeOffset));
    timeSlider.value = timeOffset;
    timeOffsetDisplay.textContent = formatTimeOffset(timeOffset);
    updateSolar420Location();
}

function calculateTimeUntil420(timezone) {
    try {
        const now = new Date();
        const offsetTime = new Date(now.getTime() + timeOffset * 60000);
        const formatter = new Intl.DateTimeFormat('en-US', {
            timeZone: timezone,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });
        const parts = formatter.formatToParts(offsetTime);
        const localHour = parseInt(parts.find(p => p.type === 'hour').value);
        const localMinute = parseInt(parts.find(p => p.type === 'minute').value);
        const localSecond = parseInt(parts.find(p => p.type === 'second').value);

        let hourDiff = 16 - localHour;
        let minuteDiff = 20 - localMinute;
        let secondDiff = -localSecond;

        if (secondDiff < 0) {
            secondDiff += 60;
            minuteDiff--;
        }
        if (minuteDiff < 0) {
            minuteDiff += 60;
            hourDiff--;
        }
        if (hourDiff < -12) {
            hourDiff += 24;
        } else if (hourDiff > 12) {
            hourDiff -= 24;
        }

        return {
            hours: hourDiff,
            minutes: minuteDiff,
            seconds: secondDiff,
            totalSeconds: hourDiff * 3600 + minuteDiff * 60 + secondDiff
        };
    } catch (e) {
        console.error(`Error calculating time until 4:20 for timezone ${timezone}:`, e);
        return null;
    }
}

function isLongitudeInRange(longitude, start, end, tolerance = 0.125) {
    // Normalize longitude to -180 to 180 range
    while (longitude > 180) longitude -= 360;
    while (longitude < -180) longitude += 360;

    // Normalize start and end to -180 to 180 range
    while (start > 180) start -= 360;
    while (start < -180) start += 360;
    while (end > 180) end -= 360;
    while (end < -180) end += 360;

    // If the range crosses the date line or wraps around
    if (start > end) {
        // Check if longitude is in either portion of the wrapped range
        return (longitude >= (start - tolerance) && longitude <= 180) || 
               (longitude >= -180 && longitude <= (end + tolerance));
    }

    // Normal range check
    return (longitude >= (start - tolerance) && longitude <= (end + tolerance));
}

function getCountriesInTimeWindow(currentLongitude) {
    const countries = new Map();
    const now = new Date();
    
    for (const [countryName, data] of Object.entries(countryTimeZones)) {
        for (const range of data.ranges) {
            // Increase tolerance for wider coverage
            if (isLongitudeInRange(currentLongitude, range[0], range[1], 30)) {
                for (const timezone of data.timezones) {
                    const timeUntil = calculateTimeUntil420(timezone);
                    if (timeUntil) {
                        const key = countryName;
                        const localTime = getLocalTime(timezone);
                        const latitudes = countryLatitudes[countryName];
                        
                        // Increased time window to 2 hours (7200 seconds)
                        if (!countries.has(key) && Math.abs(timeUntil.totalSeconds) <= 7200) {
                            countries.set(key, {
                                timeUntil: timeUntil,
                                totalSeconds: timeUntil.totalSeconds,
                                timestamp: now.getTime() + (timeUntil.totalSeconds * 1000),
                                localTime: localTime,
                                latitudes: latitudes
                            });
                        }
                    }
                }
            }
        }
    }
    return countries;
}

function formatCountdown(timeObj) {
    if (!timeObj) return "N/A";
    
    const elapsedSeconds = Math.abs(timeObj.totalSeconds);
    const hours = Math.floor(elapsedSeconds / 3600);
    const minutes = Math.floor((elapsedSeconds % 3600) / 60);
    const seconds = Math.floor(elapsedSeconds % 60);
    
    const prefix = timeObj.totalSeconds < 0 ? "-" : "";
    
    if (hours > 0) {
        return `${prefix}${hours}h:${String(minutes).padStart(2, '0')}m`;
    }
    return `${prefix}${String(minutes).padStart(2, '0')}m:${String(seconds).padStart(2, '0')}s`;
}

function updateInfoBox(longitudeDiff, countriesInWindow) {
    const infoBox = document.getElementById('infoBox');
    
    function updateContent() {
        const sortedCountries = Array.from(countriesInWindow.entries()).sort((a, b) => {
            return a[1].totalSeconds - b[1].totalSeconds;
        });

        infoBox.innerHTML = `
            <div class="longitude">Solar 4:20 @ ${longitudeDiff.toFixed(1)}° (UTC${longitudeDiff >= 0 ? '+' : ''}${(longitudeDiff/15).toFixed(1)})</div>
            <div class="countries-container">
                <div class="countries-list">
                    ${sortedCountries.map(([country, info]) => `
                        <span class="country-tag ${info.isNext ? 'next' : ''}">
                            ${country}
                            <span class="time-detail ${info.isNext ? 'next' : ''}">
                                ${info.localTime || 'N/A'} (${formatCountdown(info.timeUntil)})
                            </span>
                        </span>`).join('')}
                </div>
            </div>`;
    }

    if (window.infoBoxInterval) {
        clearInterval(window.infoBoxInterval);
    }

    updateContent();
    window.infoBoxInterval = setInterval(updateContent, 1000);
}

function updateSolar420Location() {
    const now = new Date();
    // Apply the time offset
    const offsetTime = new Date(now.getTime() + timeOffset * 60000);
    
    const utcHours = offsetTime.getUTCHours();
    const utcMinutes = offsetTime.getUTCMinutes();
    const utcSeconds = offsetTime.getUTCSeconds();
    const utcMilliseconds = offsetTime.getUTCMilliseconds();

    const currentDecimalHours = utcHours + (utcMinutes / 60) + (utcSeconds / 3600) + (utcMilliseconds / 3600000);
    const targetHour = 16 + (20 / 60);
    let longitudeDiff = (targetHour - currentDecimalHours) * 15;

    while (longitudeDiff > 180) longitudeDiff -= 360;
    while (longitudeDiff < -180) longitudeDiff += 360;

    let currentLongitude = longitudeDiff;
    const countriesInWindow = getCountriesInTimeWindow(currentLongitude);

    let nextTimeSeconds = Infinity;
    let nextLongitude = currentLongitude;

    countriesInWindow.forEach((info, countryName) => {
        if (info.totalSeconds > 0 && info.totalSeconds < nextTimeSeconds) {
            nextTimeSeconds = info.totalSeconds;
            const hoursUntilNext = info.totalSeconds / 3600;
            nextLongitude = currentLongitude - (hoursUntilNext * 15);
            while (nextLongitude > 180) nextLongitude -= 360;
            while (nextLongitude < -180) nextLongitude += 360;
        }
    });

    nextHighlights.forEach(highlight => {
        if (highlight) map.removeLayer(highlight);
    });
    nextHighlights = [];

    if (currentBar) map.removeLayer(currentBar);
    if (currentLabel) map.removeLayer(currentLabel);

    countriesInWindow.forEach((info, countryName) => {
        if (Math.abs(info.totalSeconds - nextTimeSeconds) < 30 && info.latitudes) {
            info.isNext = true;
            const highlight = L.rectangle([
                [info.latitudes[0], nextLongitude - barWidth/2],
                [info.latitudes[1], nextLongitude + barWidth/2]
            ], {
                color: '#1db954',
                weight: 2,
                fillColor: '#1db954',
                fillOpacity: 0.4
            }).addTo(map);
            nextHighlights.push(highlight);
        }
    });

    currentBar = L.rectangle([
        [-80, currentLongitude - barWidth/2],
        [80, currentLongitude + barWidth/2]
    ], {
        color: '#FF4B20',
        weight: 2,
        fillColor: '#FF4B20',
        fillOpacity: 0.3
    }).addTo(map);

    currentLabel = L.marker([45, currentLongitude], {
        icon: L.divIcon({
            className: 'bar-label',
            html: '4:20',
            iconSize: [30, 20],
            iconAnchor: [15, 10]
        })
    }).addTo(map);

    if (!document.querySelector('.central-time-display')) {
        const centralTimeDisplay = document.createElement('div');
        centralTimeDisplay.className = 'central-time-display';
        document.body.appendChild(centralTimeDisplay);
    }

    const centralTimeDisplay = document.querySelector('.central-time-display');
    centralTimeDisplay.innerHTML = `
        <div class="time-row">
            <span class="time-label">UTC</span>
            <span class="time-value">${utcHours.toString().padStart(2, '0')}:${
                utcMinutes.toString().padStart(2, '0')}:${
                utcSeconds.toString().padStart(2, '0')}</span>
        </div>
        <div class="time-row">
            <span class="time-label">LOCAL</span>
            <span class="time-value">${formatTime(offsetTime)}</span>
        </div>
        ${timeOffset !== 0 ? '<div class="time-offset">Offset: ' + formatTimeOffset(timeOffset) + '</div>' : ''}
    `;
    

    const nextBar = L.rectangle([
        [-80, nextLongitude - barWidth/2],
        [80, nextLongitude - barWidth/2]
    ], {
        color: '#1db954',
        weight: 2,
        fillColor: '#1db954',
        fillOpacity: 0.3
    }).addTo(map);
    nextHighlights.push(nextBar);

    const nextLabel = L.marker([55, nextLongitude], {
        icon: L.divIcon({
            className: 'bar-label',
            html: 'Next',
            iconSize: [30, 20],
            iconAnchor: [15, 10]
        })
    }).addTo(map);
    nextHighlights.push(nextLabel);

    countriesInWindow.forEach((info, countryName) => {
        if (info.isNext && autoFollow) {
            map.setView([info.latitudes[0], nextLongitude], 4);
        }
    });

    updateInfoBox(currentLongitude, countriesInWindow);
        
}

const followButton = L.control({position: 'topleft'});
followButton.onAdd = function(map) {
    const div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
    div.innerHTML = '<a href="#" title="Toggle Auto-follow" style="font-weight: bold;">F</a>';
    div.firstChild.addEventListener('click', function(e) {
        e.preventDefault();
        autoFollow = !autoFollow;
        div.firstChild.style.backgroundColor = autoFollow ? '#FF4B20' : 'white';
        div.firstChild.style.color = autoFollow ? 'white' : 'black';
    });
    return div;
};
followButton.addTo(map);

updateSolar420Location();
setInterval(updateSolar420Location, 1000);
</script>
</body>
</html>